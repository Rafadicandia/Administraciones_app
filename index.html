<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Vencimientos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    :root { 
      --font-size: 16px; 
      --primary: #007bff;
    }
    body { padding: 20px; background-color: #f4f7f6; }
    main.container { max-width: 1000px; }
    #loader { text-align: center; padding: 40px; }
    .grid { display: grid; grid-template-columns: 1fr auto; gap: 20px; }
    dialog header { display: flex; justify-content: space-between; align-items: center; }
    dialog h5 { margin: 0; }
    article { margin-bottom: 2rem; }
    table { margin-top: 1rem; }
    #property-details-container {
        border: 1px solid var(--contrast);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        margin-top: 1.5rem;
    }
    button[aria-busy="true"] {
      pointer-events: none;
    }
    #property-data dl, #form-edit-property {
        display: grid;
        grid-template-columns: max-content auto;
        gap: 10px 20px;
        align-items: center;
    }
    #property-data dt, #form-edit-property label {
        font-weight: bold;
        grid-column: 1;
    }
    #property-data dd, #form-edit-property input, #form-edit-property textarea {
        grid-column: 2;
        margin: 0;
    }
  </style>
</head>
<body>
  <main class="container">
    <header style="text-align: center; margin-bottom: 2rem;">
    
      <img src="https://www.bienseguro.com.uy/assets/images/logo.svg" alt="Logo de Bien Seguro" style="max-width: 200px; margin: 1rem auto;">
      <p>Panel central para el seguimiento de propiedades y sus vencimientos.</p>
    </header>

    <!-- Sección del Dashboard con Filtro de Fechas -->
    <article id="dashboard">
      <header>
        <strong>Filtrar Vencimientos por Fecha</strong>
      </header>
      <div class="grid" style="grid-template-columns: 1fr 1fr auto; align-items: end; gap: 10px;">
        <div>
          <label for="start-date">Fecha de Inicio</label>
          <input type="date" id="start-date">
        </div>
        <div>
          <label for="end-date">Fecha de Fin</label>
          <input type="date" id="end-date">
        </div>
        <button id="filter-button" onclick="handleFilterVencimientos()">Filtrar</button>
      </div>
      <div id="dashboard-loader" aria-busy="true" style="display: none;">Filtrando vencimientos...</div>
      <table role="grid" id="vencimientos-proximos-table" style="display:none;">
        <thead>
          <tr>
            <th>Dirección</th>
            <th>Propietario</th>
            <th>Tipo</th>
            <th>Fecha Vencimiento</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="vencimientos-proximos-body"></tbody>
      </table>
      <div id="dashboard-empty" style="display:none; text-align:center; padding: 20px; border: 1px dashed; border-radius: 5px;">
        <p>✅ No se encontraron vencimientos en el rango de fechas seleccionado.</p>
      </div>
    </article>

    <!-- Sección de Búsqueda de Propiedades con Desplegable -->
    <article id="propiedades">
      <header><strong>Buscar Propiedad</strong></header>
      <div class="grid">
        <select id="property-select" aria-busy="true">
          <option value="">Cargando propiedades...</option>
        </select>
        <button id="search-button" onclick="searchProperty()">Buscar</button>
      </div>
      <div id="property-details-container" style="display:none;">
         <h4 id="property-title"></h4>
         <div id="property-data"></div>
         <hr>
         <h5>Vencimientos Asociados</h5>
         <table role="grid">
           <thead>
             <tr>
               <th>Tipo de Vencimiento</th>
               <th>Fecha</th>
               <th>Acciones</th>
             </tr>
           </thead>
           <tbody id="property-vencimientos-body"></tbody>
         </table>
      </div>
    </article>
    
    <!-- Modal para editar VENCIMIENTOS -->
    <dialog id="modal-edit-vencimiento">
      <article>
        <header>
          <h5>Editar Vencimiento</h5>
          <a href="#" aria-label="Close" class="close" onclick="closeModal('modal-edit-vencimiento')"></a>
        </header>
        <form id="form-edit-vencimiento"></form>
        <footer>
          <button type="button" class="secondary" onclick="closeModal('modal-edit-vencimiento')">Cancelar</button>
          <button type="submit" form="form-edit-vencimiento">Guardar Cambios</button>
        </footer>
      </article>
    </dialog>

    <!-- Modal para ver/editar PROPIEDADES -->
    <dialog id="modal-edit-property">
      <article>
        <header>
          <h5 id="property-modal-title">Detalles de la Propiedad</h5>
          <a href="#" aria-label="Close" class="close" onclick="closeModal('modal-edit-property')"></a>
        </header>
        <form id="form-edit-property"></form>
        <footer>
          <button type="button" class="secondary" onclick="closeModal('modal-edit-property')">Cerrar</button>
          <button type="submit" form="form-edit-property">Guardar Cambios</button>
        </footer>
      </article>
    </dialog>

  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz1YjoBUmSW-do2vbN6jg2NauSt8Fe0XC_9rCOv_u3d1VWNXLGEQfi_m5qCEniibU95/exec"; // ❗️❗️❗️ RECUERDA PEGAR TU URL AQUÍ ❗️❗️❗️
    let VENCIMIENTO_DEFS = {};
    let CURRENT_PADRON = null;

    async function callApi(action, payload = {}) {
      if (API_URL === "URL_DE_TU_APPS_SCRIPT_AQUI") {
        throw new Error("Por favor, configura la URL de la API en la variable API_URL del script.");
      }
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ action, payload }),
        redirect: 'follow'
      });
      if (response.headers.get("content-type")?.includes("application/json")) {
        const result = await response.json();
        if (result.status === 'error') throw new Error(result.message);
        return result.data;
      } else {
        const text = await response.text();
        console.error("Respuesta inesperada (no-JSON):", text);
        throw new Error("Se recibió una respuesta inesperada del servidor.");
      }
    }

    function formatDisplayDate(dateString) {
      if (!dateString || isNaN(new Date(dateString))) { return 'Sin fecha'; }
      return new Date(dateString + 'T00:00:00').toLocaleDateString('es-ES');
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializePage();
      document.getElementById('form-edit-vencimiento').addEventListener('submit', handleUpdateVencimiento);
      document.getElementById('form-edit-property').addEventListener('submit', handleUpdateProperty);
    });

    function initializePage() {
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      const today = new Date();
      const thirtyDaysFromNow = new Date();
      thirtyDaysFromNow.setDate(today.getDate() + 30);
      startDateInput.value = today.toISOString().slice(0, 10);
      endDateInput.value = thirtyDaysFromNow.toISOString().slice(0, 10);
      
      handleFilterVencimientos();
      populatePropertyDropdown();

      callApi('getVencimientoDefinitions')
        .then(defs => { VENCIMIENTO_DEFS = defs; })
        .catch(showError);
    }

    async function populatePropertyDropdown() {
      const select = document.getElementById('property-select');
      try {
        const properties = await callApi('getAllPropertiesForDropdown');
        select.innerHTML = '<option value="">-- Seleccione una propiedad --</option>';
        properties.forEach(prop => {
          if (prop.padron) {
            const option = document.createElement('option');
            option.value = prop.padron;
            option.textContent = `${prop.direccion || 'Sin dirección'} - Padrón: ${prop.padron} (${prop.propietario || 'Sin propietario'})`;
            select.appendChild(option);
          }
        });
      } catch (error) {
        select.innerHTML = '<option value="">Error al cargar propiedades</option>';
        showError(error);
      } finally {
        select.removeAttribute('aria-busy');
      }
    }

    async function handleFilterVencimientos() {
      const loader = document.getElementById('dashboard-loader');
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      if (!startDate || !endDate) { return showError({ message: "Por favor, seleccione una fecha de inicio y de fin."}); }
      
      loader.style.display = 'block';
      document.getElementById('vencimientos-proximos-table').style.display = 'none';
      document.getElementById('dashboard-empty').style.display = 'none';

      try {
        const vencimientos = await callApi('filterVencimientos', { startDate, endDate, vencimientoTypeKey: 'Todos' });
        displayUpcomingVencimientos(vencimientos);
      } catch (error) {
        showError(error);
        loader.textContent = 'Error al cargar el dashboard.';
      } finally {
        if (loader) loader.style.display = 'none';
      }
    }

    function displayUpcomingVencimientos(vencimientos) {
      const tableBody = document.getElementById('vencimientos-proximos-body');
      const table = document.getElementById('vencimientos-proximos-table');
      const emptyDiv = document.getElementById('dashboard-empty');
      tableBody.innerHTML = '';

      if (!vencimientos || vencimientos.length === 0) {
        table.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
      }
      
      vencimientos.forEach(v => {
        const fechaKey = Object.keys(v).find(k => k.includes('fecha'));
        const detalle = v.nro_tributo || v.tipo_de_reajuste || v.nro_saneamiento || 'N/A';
        tableBody.innerHTML += `
          <tr>
            <td>${v.direccion || 'N/A'}</td>
            <td>${v.propietario || 'N/A'}</td>
            <td>${v.tipovencimiento || 'N/A'}</td>
            <td>${formatDisplayDate(v[fechaKey])}</td>
            <td><button class="outline" onclick="openPropertyModal('${v.padron}')">Ver Propiedad</button></td>
          </tr>`;
      });
      emptyDiv.style.display = 'none';
      table.style.display = 'table';
    }

    async function searchProperty() {
      const padron = document.getElementById('property-select').value;
      CURRENT_PADRON = padron;
      if (!padron) { return showError({ message: 'Por favor, seleccione una propiedad del desplegable.' }); }
      
      const button = document.getElementById('search-button');
      button.setAttribute('aria-busy', 'true');
      
      try {
        const result = await callApi('getPropertyAndVencimientos', { padron });
        displayPropertyDetails(result);
      } catch (error) {
        showError(error);
        document.getElementById('property-details-container').style.display = 'none';
      } finally {
        button.setAttribute('aria-busy', 'false');
      }
    }
    
    function displayPropertyDetails({ property, vencimientos }) {
      const container = document.getElementById('property-details-container');
      if (!property || !property.padron) {
        showError({ message: 'No se encontró ninguna propiedad con ese padrón.' });
        container.style.display = 'none';
        return;
      }
      
      document.getElementById('property-title').textContent = `Detalles de Padrón: ${property.padron}`;
      
      const dataContainer = document.getElementById('property-data');
      dataContainer.innerHTML = ''; 
      const dl = document.createElement('dl');
      const propertyFieldOrder = [ { key: 'direccion', label: 'Dirección' }, { key: 'propietario', label: 'Propietario' }, { key: 'localidad', label: 'Localidad' }, { key: 'edificio', label: 'Edificio' } ];
      const displayedKeys = new Set();
      propertyFieldOrder.forEach(field => {
        if (property[field.key]) {
          const dt = document.createElement('dt');
          dt.textContent = field.label;
          const dd = document.createElement('dd');
          dd.textContent = property[field.key];
          dl.appendChild(dt);
          dl.appendChild(dd);
          displayedKeys.add(field.key);
        }
      });
      for (const [key, value] of Object.entries(property)) {
        if (!value || displayedKeys.has(key) || key === '_rowindex' || key === 'padron' || key === 'vencimientos') { continue; }
        const dt = document.createElement('dt');
        dt.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const dd = document.createElement('dd');
        dd.textContent = value;
        dl.appendChild(dt);
        dl.appendChild(dd);
      }
      dataContainer.appendChild(dl);

      const vencBody = document.getElementById('property-vencimientos-body');
      vencBody.innerHTML = '';
      vencimientos.sort((a,b) => a._tipovencimiento.localeCompare(b._tipovencimiento));
      vencimientos.forEach(v => {
        const fechaKey = Object.keys(v).find(k => k.includes('fecha'));
        vencBody.innerHTML += `
          <tr>
            <td>${v._tipovencimiento}</td>
            <td>${formatDisplayDate(v[fechaKey])}</td>
            <td><button class="outline" onclick="openEditModal(${v._rowindex}, '${v._tipovencimiento}')">Editar</button></td>
          </tr>`;
      });
      container.style.display = 'block';
    }
    
    async function openEditModal(rowIndex, tipoVencimientoKey) {
        const form = document.getElementById('form-edit-vencimiento');
        form.innerHTML = '<p aria-busy="true">Cargando datos...</p>';
        document.getElementById('modal-edit-vencimiento').showModal();
        try {
            const vencimientoData = await callApi('getVencimientoDetails', { rowIndex, tipoVencimientoKey });
            populateVencimientoForm(vencimientoData, tipoVencimientoKey, form);
        } catch (error) {
            showError(error);
            closeModal('modal-edit-vencimiento');
        }
    }
    
    function populateVencimientoForm(data, tipoVencimientoKey, form) {
      form.innerHTML = '';
      const fields = VENCIMIENTO_DEFS[tipoVencimientoKey];
      if (!fields) {
          form.innerHTML = '<p>Error: No se encontraron definiciones para este tipo de vencimiento.</p>';
          return;
      }
      form.dataset.tipoVencimiento = tipoVencimientoKey;
      form.dataset.rowIndex = data._rowindex;
      fields.forEach(field => {
          const value = data[field.key] || '';
          const label = document.createElement('label');
          label.textContent = field.label;
          let input;
          if (field.type === 'textarea') {
              input = document.createElement('textarea');
              input.textContent = value;
              input.rows = 3;
          } else {
              input = document.createElement('input');
              input.type = field.type;
              input.value = value;
          }
          input.name = field.key;
          input.id = `edit-${field.id}`;
          if (field.disabled) input.readOnly = true;
          label.appendChild(input);
          form.appendChild(label);
      });
    }

    async function handleUpdateVencimiento(event) {
        event.preventDefault();
        const form = event.target;
        const tipoVencimientoKey = form.dataset.tipoVencimiento;
        const submitButton = form.parentElement.querySelector('button[type="submit"]');
        const data = { _rowindex: parseInt(form.dataset.rowIndex) };
        const formData = new FormData(form);
        for(let [key, value] of formData.entries()) { data[key] = value; }

        submitButton.setAttribute('aria-busy', 'true');
        try {
            const response = await callApi('updateVencimiento', { vencimientoData: data, tipoVencimientoKey });
            alert(response);
            closeModal('modal-edit-vencimiento');
            if (CURRENT_PADRON) searchProperty();
            handleFilterVencimientos();
        } catch (error) {
            showError(error);
        } finally {
            submitButton.setAttribute('aria-busy', 'false');
        }
    }

    async function openPropertyModal(padron) {
      if (!padron || padron === 'N/A') { return showError({ message: "No hay un padrón válido para esta entrada."}); }
      const form = document.getElementById('form-edit-property');
      const modal = document.getElementById('modal-edit-property');
      const title = document.getElementById('property-modal-title');
      
      form.innerHTML = '<p aria-busy="true">Cargando datos de la propiedad...</p>';
      title.textContent = 'Cargando...';
      modal.showModal();
      
      try {
          const { property } = await callApi('getPropertyAndVencimientos', { padron });
          if (!property) throw new Error('No se pudo encontrar la propiedad.');
          populatePropertyForm(property, form);
          title.textContent = `Editando Propiedad - Padrón: ${property.padron}`;
      } catch (error) {
          showError(error);
          closeModal('modal-edit-property');
      }
    }

    function populatePropertyForm(data, form) {
        form.innerHTML = '';
        form.dataset.rowIndex = data._rowindex;
        for (const [key, value] of Object.entries(data)) {
            if (key === '_rowindex' || key === 'vencimientos') continue;
            
            const label = document.createElement('label');
            label.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            let input;
            // Usar un textarea para campos con texto largo como 'notas' o 'garantias'
            if (key.includes('notas') || key.includes('garantias')) {
                input = document.createElement('textarea');
                input.textContent = value || '';
                input.rows = 3;
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.value = value || '';
            }
            
            input.name = key;
            if (key === 'padron') { input.readOnly = true; }
            
            form.appendChild(label);
            form.appendChild(input);
        }
    }

    async function handleUpdateProperty(event) {
        event.preventDefault();
        const form = event.target;
        const submitButton = form.parentElement.querySelector('button[type="submit"]');
        const data = { _rowindex: parseInt(form.dataset.rowIndex) };
        const formData = new FormData(form);
        for(let [key, value] of formData.entries()) { data[key] = value; }

        submitButton.setAttribute('aria-busy', 'true');
        try {
            const response = await callApi('updateProperty', { propertyData: data });
            alert(response);
            closeModal('modal-edit-property');
            // Recargar datos para que se reflejen los cambios en toda la app
            handleFilterVencimientos();
            populatePropertyDropdown();
        } catch (error) {
            showError(error);
        } finally {
            submitButton.setAttribute('aria-busy', 'false');
        }
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).close();
    }

    function showError(error) {
      console.error(error);
      alert('Error: ' + error.message);
    }
  </script>
</body>
</html>

